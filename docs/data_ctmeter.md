# Current Transformer Data

This is the data for installed current transformers (CT) for an Envoy-metered. Class [EnvoyMeterData](#pyenphase.models.meters.EnvoyMeterData).

Depending on how many and which CT are installed, data is available in:

- [Envoy.data.ctmeter_production](#pyenphase.EnvoyData.ctmeter_production)
- [Envoy.data.ctmeter_consumption](pyenphase.EnvoyData.ctmeter_consumption)
- [Envoy.data.ctmeter_production_phases](pyenphase.EnvoyData.ctmeter_production_phases)
- [Envoy.data.ctmeter_consumption_phases](pyenphase.EnvoyData.ctmeter_consumption_phases)

There is one ct for production and one for consumption. One or both of these can be installed and enabled. Data is only available if CT's are enabled.

```python
    data: EnvoyData = await envoy.update()

    production_ct = data.ctmeter_production

    print(f'eid: {production_ct.eid}')
    print(f'timestamp: {production_ct.timestamp}')
    print(f'energy_delivered: {production_ct.energy_delivered}')
    print(f'energy_received: {production_ct.energy_received}')
    print(f'power_factor: {production_ct.power_factor}')
    print(f'active_power: {production_ct.active_power}')
    print(f'voltage: {production_ct.voltage}')
    print(f'current: {production_ct.current}')
    print(f'frequency: {production_ct.frequency}')
    print(f'state: {production_ct.state}')
    print(f'measurement_type: {production_ct.measurement_type}')
    print(f'metering_status: {production_ct.metering_status}')
    print(f'status_flags: {production_ct.status_flags}')

```

Phase data is only populated if CT's are installed on more then 1 phase for production and/or consumption phases. To detect how many CT are installed use Envoy property [ct_meter_count](#pyenphase.Envoy.ct_meter_count). If only one CT meter is installed one can identify which one by testing the [Envoy.data.ctmeter_production](#pyenphase.EnvoyData.ctmeter_production) or [Envoy.data.ctmeter_consumption](pyenphase.EnvoyData.ctmeter_consumption).

```python
    how_many_ct = envoy.ct_meter_count


    consumption_ct = 'installed' if Envoy.data.ctmeter_consumption else 'not installed'
    procuction_ct = 'installed' if Envoy.data.ctmeter_production else 'not installed'

    print(f'This envoy has Production ct {procuction_ct} and Consumption CT {consumption_ct}')

```

## Consumption CT options

The consumption CT can be installed in 1 of 2 configurations. Either `Solar + Load` or `Load only`. The property [Envoy.consumption_meter_type](#pyenphase.Envoy.consumption_meter_type) will show in [which mode](#pyenphase.models.meters.CtType) the CT is operating, either `net-consumption`or `total-consumption`.

When in `net-consumption` mode, the [energy_delivered](#pyenphase.models.meters.EnvoyMeterData.energy_delivered) property reports net-energy _delivered to your site/received from the grid_ while [energy_received](#pyenphase.models.meters.EnvoyMeterData.energy_received) reports net-energy _recived from your site/send to the grid_ to the grid.[^1] [^2] When in `total-consumption` it only reports on the load (house) consumption.

[Active_power](#pyenphase.models.meters.EnvoyMeterData.active_power) is the current power flow and will be positive or negative based on actual flow of energy.

[^1]: Provided the CT is installed on the main grid entry.
[^2]: Variations between firmware release may exist.

```python

    net_consumption = envoy.data.consumption_ct.energy_delivered
    net_production = envoy.data.consumption_ct.energy_received
    net_power = envoy.data.consumption_ct.active_power

```

## Production CT Options

The production CT is installed to measure solar production. The [energy_delivered](#pyenphase.models.meters.EnvoyMeterData.energy_delivered) property reports the energy generated by the solar while [energy_received](#pyenphase.models.meters.EnvoyMeterData.energy_received) reports energy consumed by the solar. The latter will be minimal and is the consumption by the inverters when it exceeds the solar production, typically only during dawn and dusk periods. [^2]

## Relation to System Production and Consumption

An Envoy metered with CT installed, sources the production and consumption data from the CT meters. The [system_production](data_production.md#system_production-data) data is sourced from the production CT. The [system_consumption](data_consumption.md#system_consumption-data) is total consumption by the load/house and is either sourced from the consmption CT in `total-consumption` mode or calculated from both production and consumption CT when in consumption CT is in `net-consumption` mode.

Net-consumption is reported in /production as an increasing/decreasing total of import and export, CT readings however provides these as 2 increasing properties. Production is reported in system_production as a single value as well.

## Multi phase

To detect if multiple phases are reporting use the Envoy property [phase_count](#pyenphase.Envoy.phase_count).

```python
    from pyenphase.const import PhaseNames

    data: EnvoyData = await envoy.update()

    if Envoy.phase_count > 1:
        for phase in data.ctmeter_production_phases:
            phase_data = data.ctmeter_production_phases[phase]
            for key in phase_data:
                print(f'{phase} {key}: [phase_data{key]}
```
